<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Display Stream</title>
    <link rel="stylesheet" href="styles/index.css">
    <link rel="stylesheet" href="styles/garbage-bins.css">
    <script type="module" src="AI-handling.js"></script>
</head>
<body>
    <video id="backgroundVideo" autoplay loop muted playsinline>
        <source src="images/paperCrumble.mp4" type="video/mp4">
    </video>
    <div class="camera-section">
        <div id="container">
            <video id="paper-ball-video" muted playsinline>
                <source src="images/crumple-paper-ball.webm" type="video/webm">
            </video>
            <video autoplay="true" id="videoElement"></video>
            <canvas id="canvasElement" style="display: none;"> </canvas>
        </div>
        <div class="scan-button-container">
            <div class="scan-button" id="scan-button"><span>SCAN</span></div>
        </div>
    </div>

    <div id="bins-container" class="bins-container">
        <div class="recycling-bin-container">
            <img id="closed-recycling-bin" class="closed-recycling-bin" src="images/recyclebinClosed.png" alt="Recycling Bin" />
            <img id="open-recycling-bin" class="open-recycling-bin disappear" src="images/recyclebinOPen.png" alt="Recycling Bin" />
        </div>
        <div class="garbage-bin-container">
            <img id="closed-garbage-bin" class="closed-garbage-bin" src="images/garbagebinClosed.png" alt="Garbage Bin" />
            <img id="open-garbage-bin" class="open-garbage-bin disappear" src="images/garbagebinOpen.png" alt="Garbage Bin" />
        </div>
        <div class="green-bin-container">
            <img id="closed-green-bin" class="closed-green-bin" src="images/greenbinClosed.png" alt="Green Bin" />
            <img id="open-green-bin" class="open-green-bin disappear"  src="images/greenbinOpen.png" alt="Green Bin" />
        </div>
    </div>

    <img id="flying-paper-ball" src="images/paper-ball (2).png" style="display: none;" />

    <div id="result"></div>

    <script type="module">
        import { findBin } from './AI-handling.js';
        import { openBin, closeBin } from './garbage-bins.js';
        
        // Initialize variables
    const resultDiv = document.getElementById('result');
    let video = document.querySelector("#videoElement");
    const canvas = document.getElementById('canvasElement');
    const scanBtn = document.getElementById('scan-button');
    const paperBallVideo = document.getElementById('paper-ball-video');

    scanBtn.addEventListener('click', handleScan);

        if(navigator.mediaDevices.getUserMedia){ //if the user media is supported
            navigator.mediaDevices.getUserMedia({ video:true }) //
            .then(function(stream){
                video.srcObject = stream;
                // allow inline playback on some mobile browsers
                video.playsInline = true;
                // update visual state when controls change
                function horizontalFlip(){
                    video.style.transform = `scaleX(${-1}) scaleY(${1})`;
                }
                horizontalFlip();
            })
            .catch (function(error){
                console.log("Something went wrong!");
            })
        }else{
            console.log("getUserMedia not supported on your browser!");
        }
    function handleScan(){
        console.log('Scan button clicked!');
        
        // Play paper crumple animation
        paperBallVideo.currentTime = 0;
        paperBallVideo.classList.add('playing');
        paperBallVideo.play();
        
        // Hide animation when it ends
        paperBallVideo.onended = () => {
            paperBallVideo.classList.remove('playing');
        };
        
        // Capture webcam image and send to AI
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
 
        const fullDataURL = canvas.toDataURL('image/jpeg');
        const imageBase64 = fullDataURL.split(',')[1];
        const mimeType = 'image/jpeg';

        findBin(imageBase64, mimeType, resultDiv, displayResults);
    }
    
    function dropPaperBall(binType) {
        const flyingBall = document.getElementById('flying-paper-ball');
        const binPositions = {
            'RECYCLING': document.getElementById('closed-recycling-bin'),
            'TRASH': document.getElementById('closed-garbage-bin'),
            'COMPOST': document.getElementById('closed-green-bin')
        };
        
        const targetBin = binPositions[binType.toUpperCase()];
        if (!targetBin) return;
        
        const binRect = targetBin.getBoundingClientRect();
        
        // Position ball above screen
        flyingBall.style.display = 'block';
        flyingBall.style.left = (binRect.left + binRect.width / 2 - 50) + 'px';
        flyingBall.style.top = '-300px';
        flyingBall.style.transition = 'none';
        
        // Force reflow
        flyingBall.offsetHeight;
        
        // Animate to bin
        flyingBall.style.transition = 'all 1.2s ease-in';
        flyingBall.style.top = (binRect.top + binRect.height / 2 - 50) + 'px';
        
        // Hide after animation
        setTimeout(() => {
            flyingBall.style.display = 'none';
        }, 1200);
    }
    
    function displayResults(result) {
        if (resultDiv) {
            resultDiv.innerHTML = `
                <h2>Results:</h2>
                <p><strong>Object:</strong> ${result.object_identified}</p>
                <p><strong>Bin:</strong> ${result.bin_destination}</p>
                <p><strong>Reasoning:</strong> ${result.reasoning}</p>
            `;
            
            // Drop paper ball into the correct bin
            dropPaperBall(result.bin_destination);
            
            // Open bin
            openBin(result.bin_destination);
            
            // Close bin after animation
            setTimeout(() => {
                closeBin(result.bin_destination);
            }, 1300);
        }
    }
</script>
</body>
</html>